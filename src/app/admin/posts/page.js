// src/app/admin/posts/page.js
"use client";

import { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import {
  PlusCircle,
  Edit,
  Eye,
  Trash2,
  ChevronLeft,
  ChevronRight,
} from "lucide-react";

import Table from "@/components/admin/ui/Table";
import Modal from "@/components/admin/ui/modal/Modal";
import AddPostForm from "@/components/admin/posts/AddPostForm";
import EditPostForm from "@/components/admin/posts/EditPostForm";

// Helper to fetch posts with pagination
const fetchPosts = async (page = 1) => {
  try {
    const res = await fetch(`/api/admin/posts?page=${page}&limit=20`, {
      method: "GET",
      headers: { "Content-Type": "application/json" },
      cache: "no-store", // Ensure we don't get cached stale data
    });

    if (!res.ok) throw new Error(`Failed to fetch posts: ${res.status}`);
    return await res.json();
  } catch (error) {
    console.error("Fetch posts error:", error);
    return { data: [], pagination: { total: 0, page: 1, pages: 1 } };
  }
};

const POSTS_COLUMNS = [
  {
    key: "title",
    header: "Title",
    className: "font-bold max-w-xs truncate",
    render: (p) => p.title || "Untitled",
  },
  {
    key: "author_id",
    header: "Author",
    render: (p) => p.author_id?.name || "Unknown",
  },
  {
    key: "created_at",
    header: "Date",
    className: "text-gray-600",
    render: (p) =>
      p.created_at ? new Date(p.created_at).toLocaleDateString() : "-",
  },
  {
    key: "status",
    header: "Status",
    render: (p) => (
      <span
        className={`px-2 py-1 rounded text-xs font-semibold border ${
          p.status === "published"
            ? "bg-green-100 text-green-800 border-green-300"
            : "bg-yellow-100 text-yellow-800 border-yellow-300"
        }`}
      >
        {p.status}
      </span>
    ),
  },
  {
    key: "actions",
    header: "Actions",
    render: (post, { handleEdit, handleDelete }) => (
      <div className="flex gap-2">
        <button
          className="p-1 rounded-full hover:bg-yellow-100 transition-colors"
          onClick={(e) => {
            e.stopPropagation();
            handleEdit(post._id);
          }}
        >
          <Edit className="w-4 h-4 text-yellow-600" />
        </button>
        <Link
          href={`/${post.slug}`}
          target="_blank"
          className="p-1 rounded-full hover:bg-blue-100 transition-colors"
          onClick={(e) => e.stopPropagation()}
        >
          <Eye className="w-4 h-4 text-blue-600" />
        </Link>
        <button
          onClick={(e) => {
            e.stopPropagation();
            handleDelete(post._id);
          }}
          className="p-1 rounded-full hover:bg-red-100 transition-colors"
        >
          <Trash2 className="w-4 h-4 text-red-600" />
        </button>
      </div>
    ),
  },
];

export default function PostsPage() {
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(true);

  // PAGINATION STATE
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingPostId, setEditingPostId] = useState(null);

  const loadData = useCallback(async (pageToLoad) => {
    setLoading(true);
    try {
      const pRes = await fetchPosts(pageToLoad);

      setPosts(Array.isArray(pRes.data) ? pRes.data : []);

      if (pRes.pagination) {
        setCurrentPage(pRes.pagination.page);
        setTotalPages(pRes.pagination.pages);
      }
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadData(currentPage);
  }, [currentPage, loadData]);

  const handleDelete = async (id) => {
    if (!window.confirm("Delete this post?")) return;
    try {
      const res = await fetch("/api/admin/posts", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ _id: id }),
      });
      if (!res.ok) throw new Error("Delete failed");
      loadData(currentPage); 
    } catch (error) {
      alert("Error deleting post");
    }
  };

  const handleEdit = (id) => {
    setEditingPostId(id);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setTimeout(() => setEditingPostId(null), 300);
  };

  const refreshList = () => {
    loadData(1); 
    closeModal();
  };

  return (
    <div className="container mx-auto px-6 pb-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold text-gray-800 uppercase">Posts</h1>
        <button
          onClick={() => {
            setEditingPostId(null);
            setIsModalOpen(true);
          }}
          className="flex items-center text-sm px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
        >
          <PlusCircle className="w-5 h-5 mr-2" /> New Post
        </button>
      </div>

      <Table
        data={posts}
        columns={POSTS_COLUMNS}
        loading={loading}
        searchable
        searchKeys={["title"]}
        handlers={{ handleEdit, handleDelete }}
      />

      {/* Pagination Controls */}
      <div className="flex justify-between items-center mt-4 border-t pt-4">
        <span className="text-sm text-gray-500">
          Page {currentPage} of {totalPages || 1}
        </span>
        <div className="flex gap-2">
          <button
            onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
            disabled={currentPage === 1 || loading}
            className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 transition-colors"
          >
            <ChevronLeft className="w-4 h-4" />
          </button>
          <button
            onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
            disabled={currentPage === totalPages || loading}
            className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 transition-colors"
          >
            <ChevronRight className="w-4 h-4" />
          </button>
        </div>
      </div>

      <Modal
        isOpen={isModalOpen}
        onClose={closeModal}
        title={editingPostId ? "Edit Post" : "Add New Post"}
        className="max-w-4xl"
      >
        {editingPostId ? (
          <EditPostForm
            postId={editingPostId}
            onPostUpdated={refreshList}
            onCancel={closeModal}
          />
        ) : (
          <AddPostForm onPostAdded={refreshList} onCancel={closeModal} />
        )}
      </Modal>
    </div>
  );
}